<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Projet | BRAIN IT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: A single-page dashboard with tab-based navigation (Tableau de Bord, Méthodologie, Gouvernance, Risques, Planning). This structure is chosen to allow non-linear, task-oriented exploration, enabling stakeholders to quickly access specific project facets without scrolling through a long document. The Dashboard provides a high-level overview, while dedicated sections allow deep dives into specific areas using interactive components (charts, cards, tables), which is more user-friendly and efficient than a static report. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Project timeline & key numbers -> Goal: Inform -> Viz: Key metric cards -> Interaction: Static display -> Justification: Quick, scannable overview.
        - Report Info: Hybrid V-Scrum methodology -> Goal: Explain/Compare -> Viz: Side-by-side HTML/CSS layout and a simple HTML flow diagram -> Interaction: Visual comparison -> Justification: Clarifies the dual-track approach better than plain text.
        - Report Info: Project Roles & RACI -> Goal: Organize/Clarify -> Viz: Interactive HTML cards & table -> Interaction: Click/hover to reveal details -> Justification: Makes dense information digestible and easy to query.
        - Report Info: Risk Matrix (Table 3) -> Goal: Analyze Relationships -> Viz: Interactive Bubble Chart (Chart.js) -> Interaction: Click bubble to see details, filter by category -> Justification: Visually prioritizes risks by criticality far more effectively than a table.
        - Report Info: Revised Gantt Chart (Table 4) -> Goal: Show Change/Time -> Viz: Gantt-style Horizontal Bar Chart (Chart.js) -> Interaction: Hover for tooltips, toggle detail level -> Justification: Provides an intuitive and dynamic view of the project schedule.
        - Library/Method: All charts use Chart.js on a Canvas element. Diagrams and layouts use HTML/CSS with Tailwind.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 400px; max-height: 50vh; }
        .nav-button { transition: all 0.3s ease; }
        .nav-button.active { background-color: #3b82f6; color: white; }
        .nav-button:not(.active):hover { background-color: #f3f4f6; }
        .section { display: none; }
        .section.active { display: block; }
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); text-align: center; }
        .risk-card { transition: all 0.3s ease; }
        .raci-cell:hover .tooltip { opacity: 1; visibility: visible; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="min-h-screen">
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-blue-600">Projet Magasin Autonome <span class="font-normal text-stone-500">| BRAIN IT</span></h1>
                    <nav class="hidden md:flex space-x-2">
                        <button data-target="dashboard" class="nav-button active px-4 py-2 rounded-md text-sm font-medium">Tableau de Bord</button>
                        <button data-target="methodology" class="nav-button px-4 py-2 rounded-md text-sm font-medium">Méthodologie</button>
                        <button data-target="governance" class="nav-button px-4 py-2 rounded-md text-sm font-medium">Gouvernance</button>
                        <button data-target="risks" class="nav-button px-4 py-2 rounded-md text-sm font-medium">Risques</button>
                        <button data-target="planning" class="nav-button px-4 py-2 rounded-md text-sm font-medium">Planning</button>
                    </nav>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Tableau de Bord du Projet</h2>
                    <p class="text-stone-600">Vue d'ensemble des indicateurs clés, des grandes phases et des risques majeurs du projet "Magasin Autonome".</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card">
                        <h3 class="text-stone-500 text-sm font-medium mb-2">DÉLAI GLOBAL</h3>
                        <p class="text-3xl font-bold">1 Année Cible</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-stone-500 text-sm font-medium mb-2">DURÉE PLANIFIÉE</h3>
                        <p class="text-3xl font-bold">221 Jours</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-stone-500 text-sm font-medium mb-2">RISQUES CRITIQUES</h3>
                        <p class="text-3xl font-bold text-red-600">3</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                         <h3 class="text-xl font-semibold mb-4">Feuille de Route Globale</h3>
                         <p class="text-stone-600 mb-4">Ce diagramme illustre les 5 phases majeures du projet, de la conception initiale au support post-lancement, sur une durée totale de 221 jours ouvrés.</p>
                        <div class="chart-container h-72 max-h-[40vh]">
                            <canvas id="mainGanttChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4">Cartographie des Risques par Criticité</h3>
                        <p class="text-stone-600 mb-4">Cette vue synthétise la répartition des risques identifiés en fonction de leur niveau de criticité (Probabilité x Gravité). Cliquez sur la section "Risques" pour une analyse interactive.</p>
                        <div class="chart-container h-72 max-h-[40vh]">
                            <canvas id="riskSummaryChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Methodology Section -->
            <section id="methodology" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Cadre Méthodologique : Le "V-Scrum"</h2>
                    <p class="text-stone-600">Ce projet adopte une approche hybride sur mesure pour sécuriser les développements complexes tout en garantissant la flexibilité nécessaire à l'application mobile. Cette section explique comment la rigueur du Cycle en V et l'agilité de Scrum sont articulées.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="border-r-0 md:border-r md:pr-8 border-stone-200">
                            <h3 class="text-xl font-semibold text-blue-700 mb-4">Cycle en V : Application Magasin</h3>
                            <p class="text-stone-600 mb-4">Idéal pour le logiciel cœur (RFID, Paiement, SAP) où les exigences sont stables et la fiabilité est primordiale.</p>
                            <ul class="space-y-2 list-disc list-inside text-stone-700">
                                <li><strong>Stabilité :</strong> Les processus physiques sont bien définis en amont.</li>
                                <li><strong>Rigueur :</strong> Validation systématique à chaque étape (conception, développement, tests).</li>
                                <li><strong>Planification :</strong> Vision séquentielle claire, rassurante pour les lots critiques.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-green-700 mb-4">Agile (Scrum) : Application Mobile</h3>
                            <p class="text-stone-600 mb-4">Parfait pour l'interface client, qui doit évoluer rapidement en fonction des retours utilisateurs.</p>
                            <ul class="space-y-2 list-disc list-inside text-stone-700">
                                <li><strong>Flexibilité :</strong> Ajustement des priorités à chaque sprint de 3 semaines.</li>
                                <li><strong>Valeur rapide :</strong> Livraison d'un produit fonctionnel (MVP) au plus tôt.</li>
                                <li><strong>Implication Client :</strong> Le marketing et l'innovation participent aux revues de sprint.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-stone-200">
                        <h3 class="text-xl font-semibold text-center mb-4">La Clé de la Synchronisation : Le Contrat d'Interface</h3>
                        <p class="text-center text-stone-600 max-w-3xl mx-auto mb-6">Pour que ces deux mondes communiquent sans accroc, une phase initiale de 3 semaines est dédiée à la création d'un "Contrat d'Interface Technique". Ce document fige les règles de communication (API) entre les deux systèmes, devenant la référence unique pour les deux équipes.</p>
                         <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 text-center">
                            <div class="p-4 bg-blue-100 border border-blue-200 rounded-lg">
                                <p class="font-semibold text-blue-800">Lot 1: Cycle en V</p>
                                <p class="text-sm text-blue-700">Planification Long Terme</p>
                            </div>
                            <div class="font-bold text-2xl text-stone-500">↔️</div>
                             <div class="p-4 bg-stone-200 border border-stone-300 rounded-lg shadow-lg">
                                <p class="font-semibold text-stone-800">Contrat d'Interface</p>
                                <p class="text-sm text-stone-600">(API figée)</p>
                            </div>
                            <div class="font-bold text-2xl text-stone-500">↔️</div>
                            <div class="p-4 bg-green-100 border border-green-200 rounded-lg">
                                <p class="font-semibold text-green-800">Lot 2: Agile</p>
                                <p class="text-sm text-green-700">Sprints de 3 semaines</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Governance Section -->
            <section id="governance" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Organisation & Gouvernance</h2>
                    <p class="text-stone-600">Le succès du projet repose sur une structure claire et des responsabilités bien définies. Explorez ici qui fait quoi, et comment les décisions sont prises.</p>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h3 class="text-xl font-semibold mb-4">Équipe Projet BRAIN IT</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="roles-container">
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Matrice des Responsabilités (RACI)</h3>
                    <p class="text-stone-600 mb-4">Le tableau ci-dessous clarifie le rôle de chaque partie prenante pour les activités et livrables majeurs du projet. Survolez une cellule pour voir la définition du rôle.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-stone-200">
                             <thead class="bg-stone-100">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-stone-600">Livrable / Activité</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">DP</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">CP-V</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">SM</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">AS</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">Client PO</th>
                                    <th class="py-2 px-4 border-b text-center text-sm font-semibold text-stone-600">Client DSI</th>
                                </tr>
                            </thead>
                            <tbody id="raci-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Risks Section -->
            <section id="risks" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Maîtrise des Risques</h2>
                    <p class="text-stone-600">Anticiper pour mieux agir. Cette section offre une vue interactive des risques projet, permettant de les analyser par catégorie et de visualiser leur criticité.</p>
                </div>
                <div class="flex justify-center mb-6 space-x-2">
                    <button class="risk-filter-btn active bg-blue-600 text-white px-4 py-2 rounded-full text-sm" data-category="Tous">Tous</button>
                    <button class="risk-filter-btn bg-white hover:bg-stone-100 px-4 py-2 rounded-full text-sm" data-category="Technologique">Technologique</button>
                    <button class="risk-filter-btn bg-white hover:bg-stone-100 px-4 py-2 rounded-full text-sm" data-category="Organisationnel">Organisationnel</button>
                    <button class="risk-filter-btn bg-white hover:bg-stone-100 px-4 py-2 rounded-full text-sm" data-category="Planification">Planification</button>
                    <button class="risk-filter-btn bg-white hover:bg-stone-100 px-4 py-2 rounded-full text-sm" data-category="Humain">Humain</button>
                    <button class="risk-filter-btn bg-white hover:bg-stone-100 px-4 py-2 rounded-full text-sm" data-category="Périmètre">Périmètre</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                         <h3 class="text-xl font-semibold mb-4">Cartographie Probabilité / Gravité</h3>
                         <p class="text-stone-600 mb-4">Cliquez sur une bulle pour afficher les détails du risque et son plan de mitigation. La taille de la bulle représente sa criticité.</p>
                        <div class="chart-container">
                            <canvas id="riskBubbleChart"></canvas>
                        </div>
                    </div>
                    <div id="risk-details-panel" class="bg-white p-6 rounded-lg shadow risk-card">
                        <h3 class="text-xl font-semibold mb-4">Détail du Risque</h3>
                        <div id="risk-details-content" class="text-stone-600">
                           <p>Sélectionnez un risque sur le graphique pour voir les détails ici.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Planning Section -->
            <section id="planning" class="section">
                 <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Planning Opérationnel</h2>
                    <p class="text-stone-600">La feuille de route détaillée du projet. Ce diagramme de Gantt interactif présente les phases, les tâches principales, et leurs dépendances pour atteindre la mise en production en un an.</p>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Diagramme de Gantt du Projet</h3>
                    <div class="chart-container h-[600px] max-h-[70vh]">
                        <canvas id="detailedGanttChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const projectData = {
            risks: [
                { id: 'R01', category: 'Planification', description: "Le délai critique de 1 an n'est pas respecté.", probability: 3, gravity: 4, strategy: 'Atténuer', actions: 'Pilotage resserré (COPROJ bi-hebdomadaire), suivi du chemin critique, allocation d\'une marge projet.', owner: 'DP' },
                { id: 'R02', category: 'Technologique', description: "La montée de version SAP provoque une rupture de compatibilité.", probability: 3, gravity: 4, strategy: 'Atténuer', actions: "Obtenir la roadmap technique de la nouvelle version SAP, concevoir une couche d'abstraction (Adapter Pattern), planifier des tests de non-régression.", owner: 'AS' },
                { id: 'R03', category: 'Organisationnel', description: "Indisponibilité des experts SAP du client.", probability: 4, gravity: 3, strategy: 'Atténuer', actions: 'Formaliser le besoin (0.5 ETP expert SAP) et obtenir la nomination officielle du référent dès le lancement.', owner: 'DP' },
                { id: 'R04', category: 'Organisationnel', description: "Désalignement des parties prenantes client (DSI, Mktg, Innov).", probability: 3, gravity: 3, strategy: 'Atténuer', actions: 'Application stricte de la matrice RACI, escalade systématique des blocages au COPROJ/COPIL.', owner: 'DP' },
                { id: 'R05', category: 'Technologique', description: "Fiabilité de lecture RFID dégradée par interférences.", probability: 2, gravity: 4, strategy: 'Atténuer', actions: 'Réaliser un POC en magasin, sélectionner une technologie performante, développer des algorithmes de correction.', owner: 'CP-V / AS' },
                { id: 'R06', category: 'Humain', description: "Turnover d'un membre clé de l'équipe.", probability: 2, gravity: 3, strategy: 'Atténuer', actions: 'Maintenir une documentation projet rigoureuse, favoriser le travail en binôme sur les modules critiques.', owner: 'DP / CP-V' },
                { id: 'R07', category: 'Périmètre', description: "Dérive du périmètre sur l'app mobile.", probability: 3, gravity: 2, strategy: 'Éviter', actions: 'Le PO Client est seul maître du backlog. Toute demande hors MVP est évaluée et validée formellement.', owner: 'SM / DP' },
                { id: 'R08', category: 'Technologique', description: "Vulnérabilités de sécurité sur les puces RFID (clonage).", probability: 2, gravity: 3, strategy: 'Atténuer', actions: 'Utiliser des puces RFID cryptées, mettre en œuvre des contrôles de sécurité côté serveur.', owner: 'AS' }
            ],
            planning: [
                { id: 1, task: 'Phase 0: Cadrage & Architecture', start: 1, end: 15, duration: 15, level: 0 },
                { id: 1.1, task: 'Ateliers Contrat Interface', start: 1, end: 10, duration: 10, level: 1 },
                { id: 1.2, task: 'Validation Contrat Interface', start: 11, end: 15, duration: 5, level: 1 },
                { id: 2, task: 'Phase 1: Lot 1 - App Magasin (V-Model)', start: 16, end: 195, duration: 180, level: 0 },
                { id: 2.1, task: 'Conception (SFD & STD)', start: 16, end: 60, duration: 45, level: 1 },
                { id: 2.2, task: 'Réalisation & TU', start: 61, end: 160, duration: 100, level: 1 },
                { id: 2.3, task: 'Tests Intégration', start: 161, end: 180, duration: 20, level: 1 },
                { id: 2.4, task: 'Documentation', start: 181, end: 195, duration: 15, level: 1 },
                { id: 3, task: 'Phase 2: Lot 2 - App Mobile (Agile)', start: 16, end: 140, duration: 125, level: 0 },
                { id: 3.1, task: 'Sprint 0', start: 16, end: 20, duration: 5, level: 1 },
                { id: 3.2, task: 'Sprints 1 à 7', start: 21, end: 125, duration: 105, level: 1 },
                { id: 3.3, task: 'Recette finale & TNR', start: 126, end: 135, duration: 10, level: 1 },
                { id: 4, task: 'Phase 3: Intégration & Recette Globale', start: 181, end: 220, duration: 40, level: 0 },
                { id: 4.1, task: 'Intégration des 2 lots', start: 181, end: 190, duration: 10, level: 1 },
                { id: 4.2, task: 'Homologation (UAT)', start: 191, end: 210, duration: 20, level: 1 },
                { id: 4.3, task: 'Tests perf & sécurité', start: 211, end: 220, duration: 10, level: 1 },
                { id: 5, task: 'Phase 4: Déploiement & Go-Live', start: 211, end: 240, duration: 30, level: 0 },
                { id: 5.1, task: 'Prépa & Livraison pré-prod', start: 211, end: 220, duration: 10, level: 1 },
                { id: 5.2, task: 'Conduite du Changement', start: 211, end: 230, duration: 20, level: 1 },
                { id: 5.3, task: 'MISE EN PRODUCTION', start: 221, end: 221, duration: 1, level: 1 },
                { id: 5.4, task: 'Support post-démarrage', start: 222, end: 231, duration: 10, level: 1 },
            ],
            roles: [
                { name: 'Ingénieur Commercial (IC)', description: 'Sponsor exécutif, garant du contrat, de la relation client et de la profitabilité.' },
                { name: 'Directeur de Projet (DP)', description: 'Chef d\'orchestre global, responsable des engagements (périmètre, qualité, coût, délai).' },
                { name: 'Architecte de Solution (AS)', description: 'Référent technique transverse, garant de la cohérence de l\'architecture et du Contrat d\'Interface.' },
                { name: 'Chef de Projet Cycle en V (CP-V)', description: 'Pilote du lot "Application Magasin", responsable de la planification et livraison de ce chantier.' },
                { name: 'Scrum Master (SM)', description: 'Facilitateur pour le lot "Application Mobile", garant du cadre Scrum et de la protection de l\'équipe.' },
                { name: 'Équipes de Développement', description: 'Experts techniques qui conçoivent, développent et testent les solutions.' },
            ],
            raci: [
                { activity: "Définition Contrat d'Interface", DP: 'A', 'CP-V': 'C', SM: 'C', AS: 'R', 'Client PO': 'C', 'Client DSI': 'A' },
                { activity: "Rédaction SFD (Lot 1)", DP: 'A', 'CP-V': 'R', SM: 'I', AS: 'C', 'Client PO': 'C', 'Client DSI': 'C' },
                { activity: "Priorisation Backlog (Lot 2)", DP: 'C', 'CP-V': 'I', SM: 'C', AS: 'I', 'Client PO': 'A', 'Client DSI': 'I' },
                { activity: "Développement Sprint (Lot 2)", DP: 'I', 'CP-V': 'I', SM: 'A', AS: 'C', 'Client PO': 'C', 'Client DSI': 'I' },
                { activity: "Validation Recette Utilisateur", DP: 'A', 'CP-V': 'C', SM: 'C', AS: 'I', 'Client PO': 'A', 'Client DSI': 'R' },
                { activity: "Gestion des changements", DP: 'A', 'CP-V': 'C', SM: 'C', AS: 'C', 'Client PO': 'A', 'Client DSI': 'C' },
            ],
            raciDefs: {
                'R': 'Réalisateur : Exécute la tâche.',
                'A': 'Approbateur : Valide le travail et est responsable du résultat final.',
                'C': 'Consulté : Doit donner son avis. Communication bidirectionnelle.',
                'I': 'Informé : Doit être tenu au courant. Communication unidirectionnelle.'
            }
        };

        let riskBubbleChart, riskSummaryChart, mainGanttChart, detailedGanttChart;

        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            populateGovernance();
            
            createRiskSummaryChart();
            createMainGanttChart();
            createRiskBubbleChart();
            createDetailedGanttChart();
            
            setupRiskFilters();
        });
        
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.section');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;

                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    sections.forEach(section => {
                        if (section.id === targetId) {
                            section.classList.add('active');
                        } else {
                            section.classList.remove('active');
                        }
                    });
                });
            });
        }
        
        function populateGovernance() {
            const rolesContainer = document.getElementById('roles-container');
            projectData.roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'p-4 bg-stone-100 rounded-lg border border-stone-200';
                card.innerHTML = `
                    <h4 class="font-semibold text-stone-800">${role.name}</h4>
                    <p class="text-sm text-stone-600">${role.description}</p>
                `;
                rolesContainer.appendChild(card);
            });

            const raciTableBody = document.getElementById('raci-table-body');
            projectData.raci.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b last:border-b-0';
                let cells = `<td class="py-3 px-4 text-sm font-medium">${item.activity}</td>`;
                Object.keys(item).filter(k => k !== 'activity').forEach(key => {
                    const role = item[key];
                    cells += `
                        <td class="raci-cell py-3 px-4 text-center font-bold relative">
                           <span class="inline-block w-6 h-6 leading-6 rounded-full text-xs text-white ${
                               {'R': 'bg-green-500', 'A': 'bg-red-500', 'C': 'bg-yellow-500', 'I': 'bg-blue-500'}[role] || 'bg-gray-300'
                           }">${role}</span>
                           <div class="tooltip absolute bottom-full mb-2 w-48 bg-gray-800 text-white text-xs rounded py-1 px-2 text-center opacity-0 invisible transition-opacity duration-300 z-10">
                             ${projectData.raciDefs[role]}
                           </div>
                        </td>`;
                });
                row.innerHTML = cells;
                raciTableBody.appendChild(row);
            });
        }

        function createRiskSummaryChart() {
            const ctx = document.getElementById('riskSummaryChart').getContext('2d');
            const criticalityLevels = { 'Faible': 0, 'Moyen': 0, 'Élevé': 0, 'Critique': 0 };
            projectData.risks.forEach(r => {
                const criticality = r.probability * r.gravity;
                if (criticality >= 12) criticalityLevels['Critique']++;
                else if (criticality >= 8) criticalityLevels['Élevé']++;
                else if (criticality >= 4) criticalityLevels['Moyen']++;
                else criticalityLevels['Faible']++;
            });

            riskSummaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(criticalityLevels),
                    datasets: [{
                        label: 'Nombre de Risques',
                        data: Object.values(criticalityLevels),
                        backgroundColor: ['#4ade80', '#facc15', '#fb923c', '#f87171'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        function createMainGanttChart() {
            const ctx = document.getElementById('mainGanttChart').getContext('2d');
            const mainPhases = projectData.planning.filter(p => p.level === 0);
            
            mainGanttChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mainPhases.map(p => p.task),
                    datasets: [{
                        label: 'Durée (jours)',
                        data: mainPhases.map(p => [p.start, p.end]),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Jours Projet' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    const item = mainPhases[context.dataIndex];
                                    return `${item.task}: ${item.duration} jours (J+${item.start} à J+${item.end})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getRiskData(category = 'Tous') {
            const filteredRisks = category === 'Tous'
                ? projectData.risks
                : projectData.risks.filter(r => r.category === category);

            return filteredRisks.map(r => ({
                x: r.probability,
                y: r.gravity,
                r: r.probability * r.gravity,
                label: r.id,
                details: r,
            }));
        }

        function createRiskBubbleChart(category = 'Tous') {
            const ctx = document.getElementById('riskBubbleChart').getContext('2d');
            if (riskBubbleChart) {
                riskBubbleChart.destroy();
            }
            
            const data = getRiskData(category);

            riskBubbleChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Risques Projet',
                        data: data,
                        backgroundColor: data.map(d => {
                             const criticality = d.r;
                             if (criticality >= 12) return 'rgba(239, 68, 68, 0.7)';
                             if (criticality >= 8) return 'rgba(249, 115, 22, 0.7)';
                             if (criticality >= 4) return 'rgba(234, 179, 8, 0.7)';
                             return 'rgba(34, 197, 94, 0.7)';
                        }),
                        borderColor: 'rgba(0,0,0,0.1)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 5, title: { display: true, text: 'Probabilité (1-4)' } },
                        y: { min: 0, max: 5, title: { display: true, text: 'Gravité (1-4)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return `${item.label}: Criticité ${item.r}`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const riskDetails = riskBubbleChart.data.datasets[0].data[elementIndex].details;
                            updateRiskDetailsPanel(riskDetails);
                        }
                    }
                }
            });
        }
        
        function updateRiskDetailsPanel(risk) {
            const panel = document.getElementById('risk-details-content');
            const criticality = risk.probability * risk.gravity;
            let criticalityClass = 'text-green-600';
            if (criticality >= 12) criticalityClass = 'text-red-600';
            else if (criticality >= 8) criticalityClass = 'text-orange-600';
            else if (criticality >= 4) criticalityClass = 'text-yellow-600';

            panel.innerHTML = `
                <h4 class="font-bold text-lg mb-2">${risk.id}: ${risk.description}</h4>
                <div class="mb-2">
                    <span class="font-semibold">Catégorie:</span> ${risk.category}
                </div>
                <div class="mb-2">
                    <span class="font-semibold">Criticité:</span> <span class="font-bold ${criticalityClass}">${criticality}</span> (P: ${risk.probability} x G: ${risk.gravity})
                </div>
                 <div class="mb-2">
                    <span class="font-semibold">Responsable:</span> ${risk.owner}
                </div>
                <div class="mt-4 pt-2 border-t">
                    <h5 class="font-semibold mb-1">Plan de Réponse (${risk.strategy})</h5>
                    <p class="text-sm">${risk.actions}</p>
                </div>
            `;
        }
        
        function setupRiskFilters() {
            const filterButtons = document.querySelectorAll('.risk-filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                    button.classList.add('active', 'bg-blue-600', 'text-white');
                    const category = button.dataset.category;
                    createRiskBubbleChart(category);
                    document.getElementById('risk-details-content').innerHTML = '<p>Sélectionnez un risque sur le graphique pour voir les détails ici.</p>';
                });
            });
        }
        
        function createDetailedGanttChart() {
            const ctx = document.getElementById('detailedGanttChart').getContext('2d');
            const tasks = projectData.planning.sort((a, b) => a.start - b.start);

            detailedGanttChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tasks.map(p => p.task),
                    datasets: [{
                        label: 'Durée (jours)',
                        data: tasks.map(p => [p.start, p.end]),
                        backgroundColor: tasks.map(p => p.level === 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(107, 114, 128, 0.6)'),
                        borderColor: tasks.map(p => p.level === 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(107, 114, 128, 1)'),
                        borderWidth: 1,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Jours Projet' } },
                        y: { ticks: { font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = tasks[context.dataIndex];
                                    return `${item.task}: ${item.duration} jours (J+${item.start} à J+${item.end})`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
